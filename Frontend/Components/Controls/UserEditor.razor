@using Frontend.Models
@using Microsoft.AspNetCore.Components
@using Frontend.DummyData
@using Frontend.Services
@inject IFirebaseAuthService FirebaseAuthService
@inject IUserService UserService
@inject IOrderService OrderService
@inject ICartService CartService

<!-- Search Bars -->
<div class="mb-3 d-flex flex-column flex-md-row gap-3">
    <input class="form-control" placeholder="Search by Email..." @bind="searchEmail" @bind:event="oninput" />
    <input class="form-control" placeholder="Search by ID..." @bind="searchId" @bind:event="oninput" />
</div>

@if (filteredUsers.Count == 0)
{
    <div class="text-center text-light">
        <img src="images/no-users.png" alt="No users found" style="max-height: 250px;" />
        <p class="text-muted">No users match the current filters.</p>
    </div>
}
else
{
    <table class="table table-bordered align-middle">
        <thead class="table-dark">
            <tr>
                <th>Email</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>ID</th>
                <th>Address</th>
                <th>Phone</th>
                <th>Role</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var user in paginatedUsers)
            {
                <tr>
                    <td><input class="form-control" @bind="user.Email" /></td>
                    <td><input class="form-control" @bind="user.FirstName" /></td>
                    <td><input class="form-control" @bind="user.LastName" /></td>
                    <td><input class="form-control" @bind="user.Id" /></td>
                    <td><input class="form-control" @bind="user.Address" /></td>
                    <td><input class="form-control" @bind="user.PhoneNumber" /></td>
                    <td>
                        <select class="form-select"id="role-select" @bind="user.Role">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                        </select>
                    </td>
                    <td class="text-center align-middle">
                        <div class="d-flex flex-column gap-1" style="min-width: 120px;">
                            <button class="btn btn-success btn-sm w-100" @onclick="() => UpdateUser(user)">Update</button>
                            <button class="btn btn-danger btn-sm w-100" @onclick="() => DeleteUser(user)">Delete</button>
                            <button class="btn btn-secondary btn-sm w-100" @onclick="() => ToggleExpanded(user.Id)">
                                @(expandedUserId == user.Id ? "▼ Hide Orders" : "▲ Show Orders")
                            </button>
                            <button class="btn btn-secondary btn-sm w-100" @onclick="() => ToggleCart(user.Id)">
                                @(expandedCartUserId == user.Id ? "▼ Hide Cart" : "▲ Show Cart")
                            </button>
                        </div>
                    </td>
                </tr>

                @if (expandedUserId == user.Id)
                {
                    <tr>
                        <td colspan="8">
                            @if (userOrders.Any())
                            {
                                <table class="table table-bordered bg-dark text-light mt-2">
                                    <thead class="table-secondary text-dark">
                                        <tr>
                                            <th>Order ID</th>
                                            <th>Products</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var order in userOrders)
                                        {
                                            <tr>
                                                <td>@order.Id</td>
                                                <td>
                                                    <ul class="mb-0">
                                                        @foreach (var product in order.Products)
                                                        {
                                                            <li>@product.Name (@product.Price.ToString("C"))</li>
                                                        }
                                                    </ul>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            }
                            else
                            {
                                <p class="text-muted">No orders found for this user.</p>
                            }
                        </td>
                    </tr>
                }
                @if (expandedCartUserId == user.Id)
                {
                    <tr>
                        <td colspan="8">
                            @if (userCartItems.Any())
                            {
                                <table class="table table-bordered bg-dark text-light mt-2">
                                    <thead class="table-secondary text-dark">
                                        <tr>
                                            <th>Product</th>
                                            <th>Quantity</th>
                                            <th>Total Price</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in userCartItems)
                                        {
                                            <tr>
                                                <!--Bind other properties when endpoints are fixed-->
                                                <td>@item.Name</td>
                                                <td>@item.Price</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            }
                            else
                            {
                                <p class="text-muted">No items in this user's cart.</p>
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>

    <!-- Pagination Controls -->
    <div class="d-flex justify-content-between align-items-center">
        <button class="btn btn-secondary" @onclick="GoToPreviousPage" disabled="@IsFirstPage">Previous</button>
        <span>Page @CurrentPage of @TotalPages</span>
        <button class="btn btn-secondary" @onclick="GoToNextPage" disabled="@IsLastPage">Next</button>
    </div>
}

@code {
    private List<User>? users = new();
    private List<Order>? orders = new();

    private string searchEmail = string.Empty;
    private string searchId = string.Empty;

    private int PageSize = 20;
    private int CurrentPage = 1;

    private string? expandedUserId = null;
    private List<Order> userOrders = new();

    private string? expandedCartUserId = null;
    private List<CartProductDto> userCartItems = new();
    private List<Cart>? carts = new();

    protected override async Task OnInitializedAsync()
    {
        users = await UserService.GetAllUsersAsync();
        orders = await OrderService.GetAllOrderAsync();
        carts = await CartService.GetAllCartsAsync();
        
    }

    private List<User> filteredUsers => users
        .Where(u =>
            (string.IsNullOrWhiteSpace(searchEmail) || u.Email.Contains(searchEmail, StringComparison.OrdinalIgnoreCase)) &&
            (string.IsNullOrWhiteSpace(searchId) || u.Id.Contains(searchId, StringComparison.OrdinalIgnoreCase)))
        .ToList();

    private List<User> paginatedUsers => filteredUsers
        .Skip((CurrentPage - 1) * PageSize)
        .Take(PageSize)
        .ToList();

    private int TotalPages => (int)Math.Ceiling((double)filteredUsers.Count / PageSize);
    private bool IsFirstPage => CurrentPage == 1;
    private bool IsLastPage => CurrentPage == TotalPages;

    private async Task ToggleCart(string userId)
    {
        if (expandedCartUserId == userId)
        {
            expandedCartUserId = null;
            userCartItems.Clear();
        }
        else
        {
            expandedCartUserId = userId;
            expandedUserId = null;
            userOrders.Clear();

            var cart = carts.FirstOrDefault(c => c.User.Id == userId);
            if (cart != null)
            {
                userCartItems = cart.CartItems;
            }
        }
    }

    private void GoToNextPage()
    {
        if (!IsLastPage) CurrentPage++;
    }

    private void GoToPreviousPage()
    {
        if (!IsFirstPage) CurrentPage--;
    }

    private async Task UpdateUser(User user)
    {
        var responseRole = FirebaseAuthService.AssignRole(user.Id, user.Role);
        var responseUpdateUser = UserService.UpdateUser(user.Id, user);

        if (responseRole.IsCompleted && responseUpdateUser.IsCompleted)
        {
            //
        }
        
    }

    private async Task DeleteUser(User user)
    {
        /*
        var response = await Http.DeleteAsync($"api/users/{user.Id}");
        if (response.IsSuccessStatusCode)
        {
            users = users.Where(u => u.Id != user.Id).ToList();
            Console.WriteLine($"Deleted user {user.Id}");
            }
        else
        {
            Console.WriteLine($"Failed to delete user {user.Id}");
            }
        */
    }

    private async Task ToggleExpanded(string userId)
    {
        if (expandedUserId == userId)
        {
            expandedUserId = null;
            userOrders.Clear();
        }
        else
        {
            expandedUserId = userId;
            expandedCartUserId = null;
            userOrders.Clear();

            var user = users.FirstOrDefault(u => u.Id == userId);
            if (user != null)
            {
                userOrders = await GetUserOrders(user);
            }
        }
    }

    private async Task<List<Order>> GetUserOrders(User user)
    {
        return orders.Where(o => o.User.Id == user.Id).ToList();
    }
}